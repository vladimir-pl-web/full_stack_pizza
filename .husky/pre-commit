#!/usr/bin/env sh

# TypeScript type check
echo ""
echo "üîπ TypeScript type-check:"
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå TypeScript failed. Commit aborted."
  exit 1
fi

echo ""
echo "üîç Pre-commit checks (staged files only)"
echo "--------------------------------------"

# –ü–æ–ª—É—á–∞–µ–º staged —Ñ–∞–π–ª—ã
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# TS/JS —Ñ–∞–π–ª—ã –¥–ª—è ESLint (–±–µ–∑ dist/.next/build)
STAGED_TS=$(echo "$STAGED_FILES" \
  | grep -E "\.(ts|tsx|js|jsx)$" \
  | grep -vE "(^|/)(dist|\.next|build|coverage|node_modules)/" || true)

# –§–∞–π–ª—ã –¥–ª—è Prettier
STAGED_PRETTIER=$(echo "$STAGED_FILES" \
  | grep -E "\.(json|md|css|scss|yml|yaml)$" || true)

# ESLint
if [ -n "$STAGED_TS" ]; then
  echo ""
  echo "üîπ ESLint:"
  echo "$STAGED_TS"
  echo ""

  echo "$STAGED_TS" | xargs npx eslint --fix --no-warn-ignored
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå ESLint failed. Commit aborted."
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  No staged TS/JS files for ESLint"
fi

# Prettier
if [ -n "$STAGED_PRETTIER" ]; then
  echo ""
  echo "üîπ Prettier:"
  echo "$STAGED_PRETTIER"
  echo ""

  echo "$STAGED_PRETTIER" | xargs npx prettier --check
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Prettier check failed. Commit aborted."
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  No staged files for Prettier"
fi

echo ""
echo "‚úÖ All checks passed. Commit allowed."
echo ""